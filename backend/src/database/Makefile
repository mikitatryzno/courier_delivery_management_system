# Courier Delivery Management System - Database Operations

.PHONY: help db-info db-create db-drop db-reset db-seed db-init db-check db-cleanup
.DEFAULT_GOAL := help

# Environment variables
ENV ?= development
PYTHON := python
DB_CLI := $(PYTHON) -m src.utils.db_cli

help: ## Show this help message
	@echo "Courier Delivery Management System - Database Operations"
	@echo ""
	@echo "Usage: make [target] [ENV=environment]"
	@echo ""
	@echo "Targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-15s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Environments: development, production, test"
	@echo "Default environment: $(ENV)"

db-info: ## Show database information
	@echo "ğŸ” Getting database information..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) info

db-create: ## Create database tables
	@echo "ğŸ”§ Creating database tables..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) create

db-drop: ## Drop database tables
	@echo "ğŸ—‘ï¸  Dropping database tables..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) drop

db-reset: ## Reset database (drop and recreate)
	@echo "ğŸ”„ Resetting database..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) reset

db-seed: ## Seed database with sample data
	@echo "ğŸŒ± Seeding database with sample data..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) seed

db-init: ## Initialize database (create + seed)
	@echo "ğŸš€ Initializing database..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) init

db-check: ## Check database connection
	@echo "ğŸ” Checking database connection..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) check

db-cleanup: ## Clean up test data
	@echo "ğŸ§¹ Cleaning up test data..."
	@ENVIRONMENT=$(ENV) $(DB_CLI) cleanup

# Migration commands
migrate-create: ## Create a new migration
	@echo "ğŸ“ Creating new migration..."
	@ENVIRONMENT=$(ENV) alembic revision --autogenerate -m "$(MSG)"

migrate-up: ## Run migrations
	@echo "â¬†ï¸  Running migrations..."
	@ENVIRONMENT=$(ENV) alembic upgrade head

migrate-down: ## Rollback last migration
	@echo "â¬‡ï¸  Rolling back migration..."
	@ENVIRONMENT=$(ENV) alembic downgrade -1

migrate-history: ## Show migration history
	@echo "ğŸ“œ Migration history:"
	@ENVIRONMENT=$(ENV) alembic history

# Docker commands
docker-db-up: ## Start PostgreSQL database container
	@echo "ğŸ³ Starting PostgreSQL container..."
	@docker-compose up -d postgres

docker-db-down: ## Stop PostgreSQL database container
	@echo "ğŸ³ Stopping PostgreSQL container..."
	@docker-compose down postgres

docker-db-logs: ## Show PostgreSQL container logs
	@echo "ğŸ“‹ PostgreSQL container logs:"
	@docker-compose logs -f postgres

# Development commands
dev-setup: ## Set up development environment
	@echo "ğŸ› ï¸  Setting up development environment..."
	@cp .env.development .env
	@make db-init ENV=development
	@echo "âœ… Development environment ready!"

prod-setup: ## Set up production environment
	@echo "ğŸ› ï¸  Setting up production environment..."
	@cp .env.production .env
	@make docker-db-up
	@sleep 10
	@make migrate-up ENV=production
	@make db-seed ENV=production
	@echo "âœ… Production environment ready!"

test-setup: ## Set up test environment
	@echo "ğŸ› ï¸  Setting up test environment..."
	@cp .env.test .env
	@make db-init ENV=test
	@echo "âœ… Test environment ready!"